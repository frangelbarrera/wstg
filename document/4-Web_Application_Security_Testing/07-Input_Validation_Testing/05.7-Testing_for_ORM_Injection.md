# Pruebas de inyección ORM

## Resumen

La [inyección de mapeo objeto-relacional (ORM)](https://capec.mitre.org/data/definitions/109.html) es un ataque que utiliza inyección SQL contra un modelo de objeto de acceso a datos generado por ORM. Desde el punto de vista de un probador, este ataque es prácticamente idéntico a un ataque de inyección SQL. Sin embargo, la vulnerabilidad de inyección existe en el código generado por la capa ORM.

Los beneficios de usar una herramienta ORM incluyen la generación rápida de una capa de objetos para comunicarse con una base de datos relacional, la estandarización de plantillas de código para estos objetos y que generalmente proporcionan un conjunto de funciones seguras para proteger contra ataques de inyección SQL. Los objetos generados por ORM pueden usar SQL o, en algunos casos, una variante de SQL, para realizar operaciones CRUD (Crear, Leer, Actualizar, Eliminar) en una base de datos. Sin embargo, es posible que una aplicación web que use objetos generados por ORM sea vulnerable a ataques de inyección SQL si los métodos pueden aceptar parámetros de entrada no sanitizados.

## Cómo probar

Las capas ORM pueden ser propensas a vulnerabilidades, ya que amplían la superficie de ataque. En lugar de apuntar directamente a la aplicación con consultas SQL, se centraría en abusar de la capa ORM para enviar consultas SQL maliciosas.

### Identificar la capa ORM

Para probar eficientemente y entender qué está sucediendo entre sus solicitudes y las consultas del backend, y como con todo lo relacionado con la realización de pruebas adecuadas, es esencial identificar la tecnología que se está utilizando. Siguiendo el capítulo de [recopilación de información](../01-Information_Gathering/README.md), debería estar al tanto de la tecnología utilizada por la aplicación en cuestión. Consulte esta [lista que mapea lenguajes a sus respectivos ORM](https://en.wikipedia.org/wiki/List_of_object-relational_mapping_software).

### Abusar de la capa ORM

Después de identificar el posible ORM que se está utilizando, se vuelve esencial entender cómo funciona su analizador, y estudiar métodos para abusar de él, o incluso si la aplicación está usando una versión antigua, identificar CVE relacionadas con la biblioteca que se está utilizando. A veces, las capas ORM no se implementan correctamente, y por lo tanto permiten al probador realizar [inyección SQL](05-Testing_for_SQL_Injection.md) normal, sin preocuparse por la capa ORM.

#### Implementación débil de ORM

Un escenario vulnerable donde la capa ORM no se implementó correctamente, tomado de [SANS](https://software-security.sans.org/developer-how-to/fix-sql-injection-in-java-hibernate):

```java
List results = session.createQuery("from Orders as orders where orders.id = " + currentOrder.getId()).list();
List results = session.createSQLQuery("Select * from Books where author = " + book.getAuthor()).list();
```

Lo anterior no implementó el parámetro posicional, que permite al desarrollador reemplazar la entrada con un `?`. Un ejemplo sería el siguiente:

```java
Query hqlQuery = session.createQuery("from Orders as orders where orders.id = ?");
List results = hqlQuery.setString(0, "123-ADB-567-QTWYTFDL").list(); // 0 es la primera posición, donde se reemplaza dinámicamente por la cadena establecida
```

Esta implementación deja la validación y sanitización para que sea realizada por la capa ORM, y la única forma de eludirla sería identificando un problema con la capa ORM.

#### Capa ORM vulnerable

Las capas ORM son código, bibliotecas de terceros la mayor parte del tiempo. Pueden ser vulnerables al igual que cualquier otra pieza de código. Un ejemplo podría ser la [biblioteca npm de sequelize ORM](https://snyk.io/blog/sequelize-orm-npm-library-found-vulnerable-to-sql-injection-attacks/) que se encontró vulnerable en 2019. En otra investigación realizada por [RIPS Tech](https://www.ripstech.com/), se identificaron elusiones en el [ORM hibernate utilizado por Java](https://hibernate.org/orm/).

Basado en su [artículo de blog](https://blog.ripstech.com/2020/exploiting-hibernate-injections/), una hoja de trucos que podría permitir al probador identificar problemas podría delinearse de la siguiente manera:

| DBMS       | Inyección SQL                                                         |
|------------|-----------------------------------------------------------------------|
| MySQL      | `abc\' INTO OUTFILE --`                                               |
<!-- markdownlint-disable-next-line MD055 MD056 -->
| PostgreSQL | `$$='$$=chr(61) || chr(0x27) and 1=pg_sleep(2) || version()'`         |
| Oracle     | `NVL(TO_CHAR(DBMS_XMLGEN.getxml('select 1 where 1337>1')),'1')!='1'`  |
| MS SQL     | `1<LEN(%C2%A0(select%C2%A0top%C2%A01%C2%A0name%C2%A0from%C2%A0users)` |

Otro ejemplo incluiría el [Laravel Query-Builder](https://laravel.com/docs/7.x/queries), que se encontró [vulnerable en 2019](https://freek.dev/1317-an-important-security-release-for-laravel-query-builder).

## Referencias

- [Wikipedia - ORM](https://en.wikipedia.org/wiki/Object-relational_mapping)
- [Nuevos métodos para explotar inyecciones ORM en aplicaciones Java (HITB16)](https://insinuator.net/2016/06/new-methods-for-exploiting-orm-injections-in-java-applications-hitb16/)
- [Diapositivas HITB2016 - Inyecciones ORM en aplicaciones Java](https://archive.conference.hitb.org/hitbsecconf2016ams/sessions/new-methods-for-exploiting-orm-injections-in-java-applications/)
- [Arreglando inyección SQL: ORM no es suficiente](https://snyk.io/blog/sql-injection-orm-vulnerabilities/)
- [PayloadsAllTheThings - Inyección HQL](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/HQL%20Injection.md)